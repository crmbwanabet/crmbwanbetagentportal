<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BwanaBet Agent Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:'Inter',system-ui,sans-serif;}
    .spinner{animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .toast{animation:slideIn .3s ease-out;}
    @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
    .stat-toggle-active{background:#059669;color:white;}
    .stat-toggle-inactive{background:#e2e8f0;color:#64748b;}
    .chat-msg{animation:chatIn .2s ease-out;}
    @keyframes chatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .chat-bubble-mine{background:#059669;color:white;border-radius:16px 16px 4px 16px;}
    .chat-bubble-theirs{background:#f1f5f9;color:#1e293b;border-radius:16px 16px 16px 4px;}
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Toast container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-[100] space-y-2"></div>

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-900 to-emerald-700 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-black p-6 text-center border-b-4 border-emerald-400">
        <h1 class="text-emerald-400 font-extrabold text-3xl tracking-tight">BWANABET</h1>
        <p class="text-slate-400 text-sm mt-1">Agent Portal</p>
      </div>
      <div class="flex border-b">
        <button id="tabLogin" onclick="switchAuthTab('login')" class="flex-1 py-3 text-sm font-bold text-emerald-600 border-b-2 border-emerald-500">Sign In</button>
        <button id="tabRegister" onclick="switchAuthTab('register')" class="flex-1 py-3 text-sm font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-600">Register</button>
      </div>
      <!-- LOGIN -->
      <div id="loginForm" class="p-6 sm:p-8">
        <div id="loginError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div class="space-y-4">
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Promo Code</label><input type="text" id="loginPromoCode" placeholder="YOUR PROMO CODE" class="w-full px-4 py-3 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none uppercase font-mono"/></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><div class="relative"><input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none pr-10"/><button type="button" onclick="togglePwVis('loginPassword',this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><i data-lucide="eye" class="h-4 w-4"></i></button></div></div>
          <button id="loginBtn" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 flex items-center justify-center gap-2"><i data-lucide="log-in" class="h-5 w-5"></i> Sign In</button>
        </div>
      </div>
      <!-- REGISTER -->
      <div id="registerForm" class="p-6 sm:p-8 hidden">
        <div id="registerError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div id="registerSuccess" class="hidden mb-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm"></div>
        <div class="space-y-3">
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label><input type="text" id="regName" placeholder="Your full name" class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400"/></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Phone *</label><input type="text" id="regPhone" placeholder="+260..." class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400"/></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="regEmail" placeholder="email@example.com" class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400"/></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Desired Promo Code *</label><input type="text" id="regPromoCode" placeholder="e.g. MYCODE" class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400 uppercase font-mono"/><p id="promoCodeStatus" class="text-xs mt-1 hidden"></p></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Password * (min 6 chars)</label><div class="relative"><input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400 pr-10"/><button type="button" onclick="togglePwVis('regPassword',this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><i data-lucide="eye" class="h-4 w-4"></i></button></div></div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Commission Plan *</label>
            <select id="regPlan" class="w-full px-4 py-2.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-400">
              <option value="per_client">Plan A: K100 per qualifying client</option>
              <option value="loss_based">Plan B: 20% of player losses</option>
            </select>
            <div class="mt-2 p-2.5 bg-slate-50 rounded-lg text-xs text-slate-600">
              <p><strong>Plan A:</strong> K100 per client who deposits ‚â•K100 AND bets ‚â•K100 on sports or casino.</p>
              <p class="mt-1"><strong>Plan B:</strong> 20% of your clients' total losses each week.</p>
            </div>
          </div>
          <div><label class="block text-sm font-medium text-slate-700 mb-1">Location</label><input type="text" id="regLocation" placeholder="City/Area" class="w-full px-4 py-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400"/></div>
          <div class="p-3 bg-slate-50 rounded-lg max-h-32 overflow-y-auto text-xs text-slate-600 border">
            <p class="font-bold mb-1">Terms & Conditions - BwanaBet Agent Program</p>
            <p>1. You agree to promote BwanaBet responsibly and ethically.</p>
            <p>2. Commission is calculated weekly based on your chosen plan.</p>
            <p>3. Plan A: K100 per client who deposits ‚â•K100 AND bets ‚â•K100 on sports or casino per week.</p>
            <p>4. Plan B: 20% of total player losses calculated weekly.</p>
            <p>5. Payouts are processed weekly via mobile money or bank transfer.</p>
            <p>6. BwanaBet reserves the right to modify commission rates with 7 days notice.</p>
            <p>7. Fraudulent activity will result in account termination and forfeiture of earnings.</p>
            <p>8. You must not make false promises or misrepresent BwanaBet services.</p>
            <p>9. Your account requires admin approval before activation.</p>
          </div>
          <div class="flex items-center gap-2"><input type="checkbox" id="regTerms" class="rounded"><label class="text-sm text-slate-700">I accept the Terms & Conditions</label></div>
          <button id="registerBtn" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 flex items-center justify-center gap-2"><i data-lucide="user-plus" class="h-5 w-5"></i> Register as Agent</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Portal -->
  <div id="mainPortal" class="hidden">
    <header class="bg-black shadow-lg sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4"><h1 class="text-emerald-400 font-extrabold text-xl">BWANABET</h1><span class="text-slate-400 text-sm">Agent Portal</span></div>
        <div class="flex items-center gap-4">
          <div class="text-right"><p class="text-white font-medium text-sm" id="agentName">Agent</p><p class="text-emerald-400 text-xs font-mono" id="agentPromoCode">CODE</p></div>
          <button id="logoutBtn" class="px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 flex items-center gap-2 text-sm"><i data-lucide="log-out" class="h-4 w-4"></i> Logout</button>
        </div>
      </div>
    </header>
    <main class="max-w-6xl mx-auto px-4 py-6">
      <div id="pendingNotice" class="hidden mb-6 p-4 bg-orange-50 border border-orange-200 rounded-xl flex items-center gap-3">
        <i data-lucide="clock" class="h-6 w-6 text-orange-500"></i>
        <div><p class="font-bold text-orange-700">Account Pending Approval</p><p class="text-sm text-orange-600">Your account is awaiting admin approval. You'll have full access once approved.</p></div>
      </div>

      <!-- Stats Cards with Weekly/Monthly/All toggle -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-slate-600">Performance Summary</h3>
        <div class="flex gap-1 rounded-lg overflow-hidden border">
          <button onclick="setStatsPeriod('weekly')" id="statsToggleWeekly" class="px-3 py-1.5 text-xs font-medium stat-toggle-inactive transition-all">This Week</button>
          <button onclick="setStatsPeriod('monthly')" id="statsToggleMonthly" class="px-3 py-1.5 text-xs font-medium stat-toggle-inactive transition-all">This Month</button>
          <button onclick="setStatsPeriod('all')" id="statsToggleAll" class="px-3 py-1.5 text-xs font-medium stat-toggle-active transition-all">All Time</button>
        </div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm p-5"><p class="text-sm text-slate-500">Clients</p><p class="text-3xl font-bold text-slate-800" id="myTotalSignups">0</p></div>
        <div class="bg-white rounded-xl shadow-sm p-5"><p class="text-sm text-slate-500">Losses</p><p class="text-3xl font-bold text-purple-600" id="myTotalLosses">K0</p></div>
        <div class="bg-white rounded-xl shadow-sm p-5"><p class="text-sm text-slate-500">Earnings</p><p class="text-3xl font-bold text-blue-600" id="myTotalEarnings">K0</p></div>
        <div class="bg-white rounded-xl shadow-sm p-5"><p class="text-sm text-slate-500">Current Balance</p><p class="text-3xl font-bold text-orange-600" id="myBalance">K0</p></div>
      </div>

      <!-- Signup Link with Copy & Share -->
      <div class="mb-6 bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3"><i data-lucide="badge" class="h-5 w-5 text-emerald-600"></i><div><p class="text-sm text-slate-500">Commission Plan</p><p class="font-bold" id="myPlanLabel">-</p></div></div>
        </div>
        <!-- Commission Plan Change -->
        <div id="commissionChangeSection" class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <div id="commissionChangeLocked" class="hidden">
            <div class="flex items-center gap-2 text-amber-700">
              <i data-lucide="lock" class="h-4 w-4"></i>
              <p class="text-sm font-medium">Plan change locked</p>
            </div>
            <p class="text-xs text-amber-600 mt-1">Last changed: <span id="lastPlanChangeDate" class="font-medium">-</span></p>
            <p class="text-xs text-amber-600">Next change available: <span id="nextPlanChangeDate" class="font-bold">-</span></p>
            <div class="mt-2 bg-amber-100 rounded-full h-2 overflow-hidden">
              <div id="planChangeProgress" class="bg-amber-500 h-full rounded-full transition-all" style="width:0%"></div>
            </div>
            <p class="text-xs text-amber-600 mt-1 text-center" id="planChangeCountdown">-</p>
          </div>
          <div id="commissionChangeAvailable" class="hidden">
            <p class="text-sm text-slate-600 mb-2">Switch your commission plan (once every 30 days):</p>
            <div class="flex gap-2">
              <button id="switchToPlanA" onclick="changeCommissionPlan('per_client')" class="flex-1 px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all">
                Plan A: K100/client
              </button>
              <button id="switchToPlanB" onclick="changeCommissionPlan('loss_based')" class="flex-1 px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all">
                Plan B: 20% losses
              </button>
            </div>
          </div>
        </div>
        </div>
        <div class="mt-3 p-3 bg-slate-50 rounded-lg">
          <p class="text-xs text-slate-500 mb-1">Your Signup Link</p>
          <div class="flex items-center gap-2">
            <p class="font-mono text-sm text-blue-600 flex-1 truncate" id="mySignupLink">-</p>
            <button onclick="copySignupLink()" class="px-3 py-1.5 bg-slate-200 hover:bg-slate-300 rounded-lg text-xs font-medium flex items-center gap-1 transition-colors" title="Copy link">
              <i data-lucide="copy" class="h-3.5 w-3.5"></i> Copy
            </button>
            <button onclick="shareWhatsApp()" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs font-medium flex items-center gap-1 transition-colors" title="Share via WhatsApp">
              <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 00.611.611l4.458-1.495A11.952 11.952 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.362 0-4.567-.82-6.3-2.188l-.44-.352-3.2 1.073 1.073-3.2-.352-.44A9.956 9.956 0 012 12C2 6.486 6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></svg>
              WhatsApp
            </button>
          </div>
        </div>
      </div>

      <!-- Tier Progress Card with Cash Prizes -->
      <div id="tierProgressCard" class="mb-6 bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-gradient-to-r from-yellow-600 to-orange-500 text-white p-4 flex items-center justify-between">
          <h3 class="font-bold flex items-center gap-2"><i data-lucide="award" class="h-5 w-5"></i> My Tier Status</h3>
          <span id="myTierBadge" class="px-3 py-1 bg-white/20 rounded-lg font-bold text-sm">‚Äî</span>
        </div>
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-sm text-slate-500">Current Commission Rate</p>
              <p class="text-2xl font-bold text-emerald-600" id="myTierRate">-</p>
            </div>
            <div class="text-right">
              <p class="text-sm text-slate-500">Active Clients (Latest Week)</p>
              <p class="text-2xl font-bold text-blue-600" id="myActiveClients">0</p>
            </div>
          </div>
          <!-- Progress bar -->
          <div class="mb-2">
            <div class="flex justify-between text-xs text-slate-500 mb-1">
              <span id="myTierLabel">No tier yet</span>
              <span id="myNextTierLabel">Next: ü•â Bronze (7 clients)</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
              <div id="tierProgressBar" class="h-3 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-500" style="width: 0%"></div>
            </div>
          </div>
          <!-- Tier ladder with cash prizes -->
          <div class="flex justify-between mt-4 px-1" id="tierLadder">
            <div class="text-center text-xs"><span class="text-lg">ü•â</span><p class="text-slate-400">7</p></div>
            <div class="text-center text-xs"><span class="text-lg">ü•à</span><p class="text-slate-400">14</p></div>
            <div class="text-center text-xs"><span class="text-lg">ü•á</span><p class="text-slate-400">21</p></div>
            <div class="text-center text-xs"><span class="text-lg">üíé</span><p class="text-slate-400">28</p></div>
          </div>
        </div>
      </div>

      <!-- Performance Chart -->
      <div class="mb-6 bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-indigo-700 text-white p-4 flex items-center justify-between">
          <h3 class="font-bold flex items-center gap-2"><i data-lucide="trending-up" class="h-4 w-4"></i> Earnings Trend</h3>
          <select id="chartMetric" onchange="renderChart()" class="bg-indigo-600 text-white border border-indigo-500 rounded px-2 py-1 text-xs">
            <option value="earnings">Earnings</option>
            <option value="clients">Clients</option>
            <option value="losses">Losses</option>
          </select>
        </div>
        <div class="p-4" style="height:250px;">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="bg-slate-800 text-white p-4 flex items-center justify-between">
            <h3 class="font-bold flex items-center gap-2"><i data-lucide="bar-chart-3" class="h-4 w-4"></i> Weekly Performance</h3>
            <button onclick="downloadReport()" class="px-3 py-1 bg-emerald-500 rounded text-sm hover:bg-emerald-600 flex items-center gap-1"><i data-lucide="download" class="h-4 w-4"></i> PDF</button>
          </div>
          <div class="overflow-x-auto max-h-[400px]">
            <table class="w-full"><thead class="bg-slate-50 sticky top-0"><tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Week</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Clients</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Qualifying</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Losses</th>
              <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Earnings</th>
            </tr></thead><tbody id="weeklyDataTable"><tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Loading...</td></tr></tbody></table>
          </div>
        </div>
        <div class="space-y-6">
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-yellow-500 text-black p-4"><h3 class="font-bold flex items-center gap-2"><i data-lucide="trophy" class="h-4 w-4"></i> Leaderboard</h3></div>
            <div class="p-2"><select id="leaderboardType" onchange="renderLeaderboard()" class="w-full px-3 py-2 border rounded-lg text-sm"><option value="earnings">By Earnings</option><option value="clients">By Clients</option></select></div>
            <div id="leaderboardContainer" class="max-h-[300px] overflow-y-auto"><div class="p-4 text-center text-slate-400">Loading...</div></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-blue-700 text-white p-4"><h3 class="font-bold flex items-center gap-2"><i data-lucide="edit" class="h-4 w-4"></i> Change Promo Code</h3></div>
            <div class="p-4">
              <div id="promoChangeCurrentStatus" class="hidden mb-3 p-2 bg-orange-50 border border-orange-200 rounded text-sm text-orange-700"></div>
              <input type="text" id="newPromoCodeInput" placeholder="NEW CODE" class="w-full px-3 py-2 border rounded-lg text-sm uppercase font-mono mb-3">
              <button onclick="requestPromoCodeChange()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Request Change (Admin Approval)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment History -->
      <div class="mt-6 bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-purple-800 text-white p-4"><h3 class="font-bold flex items-center gap-2"><i data-lucide="receipt" class="h-4 w-4"></i> Payment History</h3></div>
        <div class="overflow-x-auto"><table class="w-full"><thead class="bg-slate-50"><tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Date</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Amount</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600">Method</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600">Status</th>
        </tr></thead><tbody id="paymentsTable"><tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">Loading...</td></tr></tbody></table></div>
      </div>

      <!-- Profile & Settings -->
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Edit Profile -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="bg-slate-700 text-white p-4"><h3 class="font-bold flex items-center gap-2"><i data-lucide="user-cog" class="h-4 w-4"></i> Edit Profile</h3></div>
          <div class="p-4 space-y-3">
            <div><label class="block text-xs font-medium text-slate-500 mb-1">Phone</label><input type="text" id="editPhone" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none"/></div>
            <div><label class="block text-xs font-medium text-slate-500 mb-1">Email</label><input type="email" id="editEmail" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none"/></div>
            <div><label class="block text-xs font-medium text-slate-500 mb-1">Location</label><input type="text" id="editLocation" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-400 outline-none"/></div>
            <button onclick="saveProfile()" class="w-full px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600 font-medium">Save Changes</button>
          </div>
        </div>
        <!-- Change Password -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="bg-red-700 text-white p-4"><h3 class="font-bold flex items-center gap-2"><i data-lucide="lock" class="h-4 w-4"></i> Change Password</h3></div>
          <div class="p-4 space-y-3">
            <div><label class="block text-xs font-medium text-slate-500 mb-1">Current Password</label><div class="relative"><input type="password" id="currentPassword" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-red-400 outline-none pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/><button type="button" onclick="togglePwVis('currentPassword',this)" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><i data-lucide="eye" class="h-4 w-4"></i></button></div></div>
            <div><label class="block text-xs font-medium text-slate-500 mb-1">New Password (min 6 chars)</label><div class="relative"><input type="password" id="newPassword" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-red-400 outline-none pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/><button type="button" onclick="togglePwVis('newPassword',this)" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><i data-lucide="eye" class="h-4 w-4"></i></button></div></div>
            <div><label class="block text-xs font-medium text-slate-500 mb-1">Confirm New Password</label><div class="relative"><input type="password" id="confirmPassword" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-red-400 outline-none pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/><button type="button" onclick="togglePwVis('confirmPassword',this)" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"><i data-lucide="eye" class="h-4 w-4"></i></button></div></div>
            <button onclick="changePassword()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 font-medium">Update Password</button>
          </div>
        </div>
      </div>

      <!-- Live Chat with Manager -->
      <div class="mt-6 bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="bg-indigo-700 text-white p-4 flex items-center justify-between">
          <h3 class="font-bold flex items-center gap-2"><i data-lucide="message-circle" class="h-4 w-4"></i> Chat with Manager</h3>
          <span id="portalChatUnread" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-0.5 font-bold">0 new</span>
        </div>
        <div id="portalChatMessages" class="p-4 space-y-3 overflow-y-auto bg-slate-50" style="height:300px;">
          <div class="flex items-center justify-center h-full text-slate-400 text-sm"><p>Loading chat...</p></div>
        </div>
        <div class="p-3 border-t bg-white">
          <div class="flex gap-2">
            <input type="text" id="portalChatInput" placeholder="Type a message..." class="flex-1 px-4 py-2.5 border rounded-xl text-sm focus:ring-2 focus:ring-indigo-400 outline-none" onkeypress="if(event.key==='Enter')PortalChat.send()">
            <button onclick="PortalChat.send()" class="px-4 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-medium flex items-center gap-1"><i data-lucide="send" class="h-4 w-4"></i> Send</button>
          </div>
        </div>
      </div>
    </main>
    <footer class="bg-slate-800 text-slate-400 text-center py-4 mt-8"><p class="text-sm">¬© 2026 BwanaBet Agent Program</p></footer>
  </div>

  <script>
    const SUPABASE_URL='https://blrrcnrhixckfudiojwe.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscnJjbnJoaXhja2Z1ZGlvandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3Nzg0MzMsImV4cCI6MjA4MzM1NDQzM30.2DGACAZz-f_r0ieYz3hvtsOG1y-3fqTD_ENH2ZR2g1k';
    const TELEGRAM_BOT_TOKEN='8565187554:AAGYGyH8v5jIRxdPEJXqEZ5IJKifA2xIEoQ';
    const App={db:null,agent:null,weeklyData:[],payments:[],leaderboard:[],tiers:[],chart:null,statsPeriod:'all'};

    // ============ PASSWORD VISIBILITY TOGGLE ============
    function togglePwVis(inputId, btn) {
      const el = document.getElementById(inputId);
      if (!el) return;
      el.type = el.type === 'password' ? 'text' : 'password';
      btn.innerHTML = el.type === 'password' ? '<i data-lucide="eye" class="h-4 w-4"></i>' : '<i data-lucide="eye-off" class="h-4 w-4"></i>';
      lucide.createIcons();
    }

    // ============ TOAST NOTIFICATIONS ============
    function showToast(msg, type='success') {
      const colors = {success:'bg-emerald-500',error:'bg-red-500',info:'bg-blue-500'};
      const el = document.createElement('div');
      el.className = `toast ${colors[type]||colors.info} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium max-w-sm`;
      el.textContent = msg;
      document.getElementById('toastContainer').appendChild(el);
      setTimeout(()=>el.remove(), 3000);
    }

    // ============ TELEGRAM ============
    async function sendTelegramToAll(text) {
      try {
        const { data: subs } = await App.db.from('telegram_subscribers').select('chat_id').eq('is_active', true);
        if (!subs || subs.length === 0) return;
        await Promise.allSettled(subs.map(s =>
          fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: s.chat_id, text, parse_mode: 'HTML' })
          })
        ));
      } catch(e) { console.error('Telegram send error:', e); }
    }

    // ============ COPY & SHARE ============
    function copySignupLink() {
      const link = App.agent?.signup_link || '';
      if (!link) return;
      navigator.clipboard.writeText(link).then(() => showToast('Link copied!')).catch(() => {
        // Fallback
        const ta = document.createElement('textarea'); ta.value = link; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        showToast('Link copied!');
      });
    }

    function shareWhatsApp() {
      const link = App.agent?.signup_link || '';
      const code = App.agent?.promo_code || '';
      const msg = `üé∞ Join BwanaBet using my promo code *${code}*!\n\nSign up here: ${link}\n\nüí∞ Start betting and win big!`;
      window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
    }

    // ============ STATS PERIOD TOGGLE ============
    function setStatsPeriod(period) {
      App.statsPeriod = period;
      ['weekly','monthly','all'].forEach(p => {
        const btn = document.getElementById('statsToggle' + p.charAt(0).toUpperCase() + p.slice(1));
        if (btn) btn.className = 'px-3 py-1.5 text-xs font-medium transition-all ' + (p === period ? 'stat-toggle-active' : 'stat-toggle-inactive');
      });
      renderStats();
    }

    function renderStats() {
      const now = new Date();
      let filtered = App.weeklyData;
      
      if (App.statsPeriod === 'weekly') {
        // Current week only (latest entry)
        filtered = App.weeklyData.length ? [App.weeklyData[0]] : [];
      } else if (App.statsPeriod === 'monthly') {
        // Current month
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        filtered = App.weeklyData.filter(w => new Date(w.week_start_date) >= monthStart);
      }
      
      const tc = filtered.reduce((s,w) => s + (w.total_clients||0), 0);
      const tl = filtered.reduce((s,w) => s + parseFloat(w.total_losses||0), 0);
      const te = filtered.reduce((s,w) => s + parseFloat(w.total_earnings||0), 0);
      const tp = App.payments.filter(p => p.status === 'paid').reduce((s,p) => s + parseFloat(p.amount||0), 0);
      
      document.getElementById('myTotalSignups').textContent = tc;
      document.getElementById('myTotalLosses').textContent = 'K' + tl.toLocaleString();
      document.getElementById('myTotalEarnings').textContent = 'K' + te.toLocaleString();
      // Balance is always all-time
      const allEarnings = App.weeklyData.reduce((s,w) => s + parseFloat(w.total_earnings||0), 0);
      document.getElementById('myBalance').textContent = 'K' + (allEarnings - tp).toLocaleString();
    }

    // ============ TIER SYSTEM ============
    App.tiers = [];
    async function loadTiers() {
      try {
        const { data } = await App.db.from('commission_tiers').select('*').order('tier_order');
        App.tiers = data || [];
      } catch(e) { App.tiers = []; }
    }

    function getAgentTier(activeClients) {
      let tier = null;
      for (const t of App.tiers.sort((a,b) => a.tier_order - b.tier_order)) {
        if (activeClients >= t.min_active_clients) tier = t;
      }
      return tier;
    }

    function renderTierProgress() {
      const card = document.getElementById('tierProgressCard');
      if (App.tiers.length === 0) { if(card) card.classList.add('hidden'); return; }
      if(card) card.classList.remove('hidden');
      let activeClients = 0;
      if (App.weeklyData.length > 0) activeClients = App.weeklyData[0].qualifying_clients || 0;

      const tier = getAgentTier(activeClients);
      const sorted = [...App.tiers].sort((a,b) => a.tier_order - b.tier_order);
      const maxClients = sorted[sorted.length - 1].min_active_clients;

      document.getElementById('myTierBadge').textContent = tier ? `${tier.emoji} ${tier.tier_name}` : '‚Äî No Tier';
      document.getElementById('myActiveClients').textContent = activeClients;

      if (tier) {
        const rate = App.agent.commission_plan === 'per_client' ? `K${tier.per_client_amount}/client` : `${tier.loss_based_rate}% of losses`;
        document.getElementById('myTierRate').textContent = rate;
      } else {
        const baseRate = App.agent.commission_plan === 'per_client' ? 'K100/client (base)' : '20% (base)';
        document.getElementById('myTierRate').textContent = baseRate;
      }

      document.getElementById('myTierLabel').textContent = tier ? `${tier.emoji} ${tier.tier_name}` : 'Below Bronze';

      let nextTier = null;
      for (const t of sorted) { if (activeClients < t.min_active_clients) { nextTier = t; break; } }
      if (nextTier) {
        const needed = nextTier.min_active_clients - activeClients;
        document.getElementById('myNextTierLabel').textContent = `Next: ${nextTier.emoji} ${nextTier.tier_name} (${needed} more client${needed!==1?'s':''})`;
      } else {
        document.getElementById('myNextTierLabel').innerHTML = 'üèÜ <b>MAX TIER!</b>';
      }

      const pct = Math.min(100, (activeClients / maxClients) * 100);
      document.getElementById('tierProgressBar').style.width = pct + '%';

      // Tier ladder with cash prizes
      document.getElementById('tierLadder').innerHTML = sorted.map(t => {
        const reached = activeClients >= t.min_active_clients;
        const prize = t.cash_prize ? `K${Number(t.cash_prize).toLocaleString()}` : '';
        return `<div class="text-center text-xs ${reached ? 'opacity-100' : 'opacity-40'}">
          <span class="text-lg">${t.emoji}</span>
          <p class="${reached ? 'text-yellow-600 font-bold' : 'text-slate-400'}">${t.min_active_clients}</p>
          ${prize ? `<p class="text-emerald-600 font-bold text-[10px] mt-0.5">üéÅ ${prize}</p>` : ''}
        </div>`;
      }).join('');
    }

    // ============ PERFORMANCE CHART ============
    function renderChart() {
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      if (App.chart) App.chart.destroy();

      const metric = document.getElementById('chartMetric')?.value || 'earnings';
      // Show last 12 weeks, oldest first
      const data = [...App.weeklyData].reverse().slice(-12);
      
      const labels = data.map(w => {
        const d = new Date(w.week_start_date);
        return d.toLocaleDateString('en-GB', {day:'numeric', month:'short'});
      });

      const config = {
        earnings: { label: 'Earnings (K)', data: data.map(w => parseFloat(w.total_earnings||0)), color: '#059669', bg: 'rgba(5,150,105,0.1)' },
        clients: { label: 'Clients', data: data.map(w => w.total_clients||0), color: '#2563eb', bg: 'rgba(37,99,235,0.1)' },
        losses: { label: 'Losses (K)', data: data.map(w => parseFloat(w.total_losses||0)), color: '#9333ea', bg: 'rgba(147,51,234,0.1)' }
      };

      const c = config[metric];
      App.chart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: c.label,
            data: c.data,
            borderColor: c.color,
            backgroundColor: c.bg,
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { font: { size: 11 } } },
            x: { ticks: { font: { size: 10 }, maxRotation: 45 } }
          }
        }
      });
    }

    // ============ AUTH ============
    document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      App.db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // SECURE: Only store agent ID, re-fetch fresh data
      const savedId = localStorage.getItem('agentSessionId');
      if (savedId) {
        try {
          const { data: agent, error } = await App.db.from('agents').select('*').eq('id', savedId).single();
          if (agent && !error) {
            App.agent = agent;
            await showPortal();
          } else {
            localStorage.removeItem('agentSessionId');
          }
        } catch(e) { localStorage.removeItem('agentSessionId'); }
      }
      
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
      document.getElementById('registerBtn').addEventListener('click', handleRegister);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('regPromoCode').addEventListener('input', checkPromoAvailability);
    });

    function switchAuthTab(tab) {
      document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
      document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
      const tl = document.getElementById('tabLogin'), tr = document.getElementById('tabRegister');
      tl.className = 'flex-1 py-3 text-sm ' + (tab === 'login' ? 'font-bold text-emerald-600 border-b-2 border-emerald-500' : 'font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-600');
      tr.className = 'flex-1 py-3 text-sm ' + (tab === 'register' ? 'font-bold text-emerald-600 border-b-2 border-emerald-500' : 'font-medium text-slate-400 border-b-2 border-transparent hover:text-slate-600');
    }

    async function handleLogin() {
      const code = document.getElementById('loginPromoCode').value.trim().toUpperCase();
      const pw = document.getElementById('loginPassword').value;
      const err = document.getElementById('loginError');
      if (!code || !pw) { err.textContent = 'Enter promo code and password'; err.classList.remove('hidden'); return; }
      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.innerHTML = '<svg class="spinner h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
      try {
        const { data: agent, error } = await App.db.from('agents').select('*').eq('promo_code', code).single();
        if (error || !agent) throw new Error('Invalid promo code');
        if (agent.password_hash !== pw) throw new Error('Incorrect password');
        if (agent.status === 'inactive') throw new Error('Account deactivated. Contact your manager.');
        App.agent = agent;
        // SECURE: Only store agent ID, NOT full object with password
        localStorage.setItem('agentSessionId', agent.id);
        err.classList.add('hidden');
        await showPortal();
      } catch(e) { err.textContent = e.message; err.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.innerHTML = '<i data-lucide="log-in" class="h-5 w-5"></i> Sign In'; lucide.createIcons(); }
    }

    let promoTimer = null;
    async function checkPromoAvailability() {
      clearTimeout(promoTimer);
      const code = document.getElementById('regPromoCode').value.trim().toUpperCase();
      const s = document.getElementById('promoCodeStatus');
      if (code.length < 2) { s.classList.add('hidden'); return; }
      promoTimer = setTimeout(async () => {
        const { data } = await App.db.from('agents').select('id').eq('promo_code', code).maybeSingle();
        s.classList.remove('hidden');
        if (data) { s.textContent = '‚ùå Code taken'; s.className = 'text-xs mt-1 text-red-600'; }
        else { s.textContent = '‚úÖ Available'; s.className = 'text-xs mt-1 text-emerald-600'; }
      }, 500);
    }

    async function handleRegister() {
      const name = document.getElementById('regName').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const code = document.getElementById('regPromoCode').value.trim().toUpperCase();
      const pw = document.getElementById('regPassword').value;
      const plan = document.getElementById('regPlan').value;
      const loc = document.getElementById('regLocation').value.trim();
      const terms = document.getElementById('regTerms').checked;
      const err = document.getElementById('registerError'), suc = document.getElementById('registerSuccess');
      err.classList.add('hidden'); suc.classList.add('hidden');
      if (!name || !phone || !code || !pw) { err.textContent = 'Fill all required fields'; err.classList.remove('hidden'); return; }
      if (pw.length < 6) { err.textContent = 'Password min 6 characters'; err.classList.remove('hidden'); return; }
      if (!terms) { err.textContent = 'Accept Terms & Conditions'; err.classList.remove('hidden'); return; }
      const btn = document.getElementById('registerBtn');
      btn.disabled = true; btn.innerHTML = '<svg class="spinner h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
      try {
        const { data: ex } = await App.db.from('agents').select('id').eq('promo_code', code).maybeSingle();
        if (ex) throw new Error('Code "' + code + '" already taken');
        const { error } = await App.db.from('agents').insert({
          promo_code: code, password_hash: pw, name, phone, email: email || null,
          commission_plan: plan, commission_rate: plan === 'loss_based' ? 20 : 0, per_client_amount: plan === 'per_client' ? 100 : 0,
          location: loc || null, signup_link: 'https://bwanabet.com/en/auth/signup/' + code,
          status: 'pending', is_active: false, self_registered: true, terms_accepted: true, terms_accepted_at: new Date().toISOString()
        });
        if (error) throw error;
        suc.innerHTML = '<strong>Registration successful!</strong><br>Your account is pending admin approval.'; suc.classList.remove('hidden');
        const planLabel = plan === 'per_client' ? 'Plan A (K100/client)' : 'Plan B (20% losses)';
        sendTelegramToAll(`üÜï <b>New Agent Registration</b>\n\nüë§ ${name}\nüîó Code: <code>${code}</code>\nüìã ${planLabel}\nüì± ${phone}\nüìç ${loc || '-'}\n\n‚è≥ <i>Awaiting approval</i>`);
        ['regName','regPhone','regEmail','regPromoCode','regPassword','regLocation'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('regTerms').checked = false;
      } catch(e) { err.textContent = e.message; err.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.innerHTML = '<i data-lucide="user-plus" class="h-5 w-5"></i> Register as Agent'; lucide.createIcons(); }
    }

    function handleLogout() {
      App.agent = null;
      localStorage.removeItem('agentSessionId');
      document.getElementById('mainPortal').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    // ============ PORTAL ============
    async function showPortal() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainPortal').classList.remove('hidden');
      document.getElementById('agentName').textContent = App.agent.name;
      document.getElementById('agentPromoCode').textContent = App.agent.promo_code;
      document.getElementById('pendingNotice').classList.toggle('hidden', App.agent.status !== 'pending');
      const pl = { per_client: 'Plan A: K100 per qualifying client', loss_based: 'Plan B: 20% of player losses', nil: 'Nil (Tracking)' };
      document.getElementById('myPlanLabel').textContent = pl[App.agent.commission_plan] || '-';
      document.getElementById('mySignupLink').textContent = App.agent.signup_link || '-';
      renderCommissionChange();
      
      // Populate profile fields
      document.getElementById('editPhone').value = App.agent.phone || '';
      document.getElementById('editEmail').value = App.agent.email || '';
      document.getElementById('editLocation').value = App.agent.location || '';

      if (App.agent.promo_code_change_status === 'pending') {
        const el = document.getElementById('promoChangeCurrentStatus');
        el.textContent = '‚è≥ Change to "' + App.agent.promo_code_change_request + '" pending approval';
        el.classList.remove('hidden');
      }
      await loadTiers();
      await loadAgentData();
      await loadLeaderboard();
      renderTierProgress();
      renderChart();
      PortalChat.init();
      lucide.createIcons();
    }

    async function loadAgentData() {
      try {
        const { data: wd } = await App.db.from('agent_weekly_data').select('*').eq('agent_id', App.agent.id).order('week_start_date', { ascending: false });
        App.weeklyData = wd || [];
        const { data: pm } = await App.db.from('agent_payments').select('*').eq('agent_id', App.agent.id).order('created_at', { ascending: false });
        App.payments = pm || [];
        renderStats();
        renderWeeklyTable();
        renderPaymentsTable();
      } catch(e) { console.error(e); }
    }

    function renderWeeklyTable() {
      const t = document.getElementById('weeklyDataTable');
      if (!App.weeklyData.length) { t.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">No data yet</td></tr>'; return; }
      t.innerHTML = App.weeklyData.map(w => `<tr class="border-t hover:bg-slate-50">
        <td class="px-4 py-3 text-sm">${new Date(w.week_start_date).toLocaleDateString()} - ${new Date(w.week_end_date).toLocaleDateString()}</td>
        <td class="px-4 py-3 text-center">${w.total_clients||0}</td>
        <td class="px-4 py-3 text-center">${w.qualifying_clients||0}</td>
        <td class="px-4 py-3 text-center">K${parseFloat(w.total_losses||0).toLocaleString()}</td>
        <td class="px-4 py-3 text-center font-bold text-emerald-600">K${parseFloat(w.total_earnings||0).toLocaleString()}</td></tr>`).join('');
    }

    function renderPaymentsTable() {
      const t = document.getElementById('paymentsTable');
      if (!App.payments.length) { t.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">No payments yet</td></tr>'; return; }
      const sc = { pending: 'orange', paid: 'emerald', cancelled: 'red' };
      t.innerHTML = App.payments.map(p => `<tr class="border-t hover:bg-slate-50">
        <td class="px-4 py-3 text-sm">${p.payment_date || p.created_at?.split('T')[0] || '-'}</td>
        <td class="px-4 py-3 font-bold">K${parseFloat(p.amount).toLocaleString()}</td>
        <td class="px-4 py-3 text-sm capitalize">${p.payment_method || '-'}</td>
        <td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-${sc[p.status]}-100 text-${sc[p.status]}-700 rounded text-xs capitalize">${p.status}</span></td></tr>`).join('');
    }

    // ============ LEADERBOARD (Promo codes only for privacy) ============
    async function loadLeaderboard() {
      try {
        const { data: agents } = await App.db.from('agents').select('id,promo_code').eq('status', 'active');
        const { data: aw } = await App.db.from('agent_weekly_data').select('*');
        App.leaderboard = (agents || []).map(a => {
          const d = (aw || []).filter(w => w.agent_id === a.id);
          return { ...a, totalClients: d.reduce((s,w) => s + (w.total_clients||0), 0), totalEarnings: d.reduce((s,w) => s + parseFloat(w.total_earnings||0), 0), isMe: a.id === App.agent.id };
        });
        renderLeaderboard();
      } catch(e) { console.error(e); }
    }

    function renderLeaderboard() {
      const type = document.getElementById('leaderboardType').value;
      const c = document.getElementById('leaderboardContainer');
      const key = type === 'clients' ? 'totalClients' : 'totalEarnings', prefix = type === 'clients' ? '' : 'K';
      const sorted = [...App.leaderboard].sort((a,b) => b[key] - a[key]);
      if (!sorted.length) { c.innerHTML = '<div class="p-4 text-center text-slate-400">No data</div>'; return; }
      c.innerHTML = sorted.map((a,i) => {
        const m = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
        return `<div class="flex items-center justify-between p-3 border-b ${a.isMe ? 'bg-emerald-50 border-l-4 border-l-emerald-500' : 'hover:bg-slate-50'}">
          <div class="flex items-center gap-3"><span class="text-lg w-8">${m}</span><div><p class="font-medium text-sm font-mono ${a.isMe ? 'text-emerald-700' : ''}">${a.promo_code}${a.isMe ? ' (You)' : ''}</p></div></div>
          <span class="font-bold text-sm">${prefix}${a[key].toLocaleString()}</span></div>`;
      }).join('');
    }

    // ============ PROMO CODE CHANGE ============
    async function requestPromoCodeChange() {
      const nc = document.getElementById('newPromoCodeInput').value.trim().toUpperCase();
      if (!nc || nc.length < 2) { alert('Enter a valid code'); return; }
      if (nc === App.agent.promo_code) { alert('Same as current'); return; }
      const { data: ex } = await App.db.from('agents').select('id').eq('promo_code', nc).maybeSingle();
      if (ex) { alert('Code "' + nc + '" is taken'); return; }
      const { error } = await App.db.from('agents').update({ promo_code_change_request: nc, promo_code_change_status: 'pending' }).eq('id', App.agent.id);
      if (error) { alert('Error: ' + error.message); return; }
      App.agent.promo_code_change_request = nc; App.agent.promo_code_change_status = 'pending';
      const el = document.getElementById('promoChangeCurrentStatus');
      el.textContent = '‚è≥ Change to "' + nc + '" pending approval'; el.classList.remove('hidden');
      document.getElementById('newPromoCodeInput').value = '';
      showToast('Request submitted! Awaiting admin approval.', 'info');
      sendTelegramToAll(`üîÑ <b>Promo Code Change Request</b>\n\nüë§ ${App.agent.name}\nüîó Current: <code>${App.agent.promo_code}</code>\n‚û°Ô∏è Requested: <code>${nc}</code>\n\n‚è≥ <i>Awaiting approval</i>`);
    }

    // ============ PROFILE EDITING ============
    async function saveProfile() {
      const phone = document.getElementById('editPhone').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const location = document.getElementById('editLocation').value.trim();
      
      if (!phone) { showToast('Phone is required', 'error'); return; }
      
      const { error } = await App.db.from('agents').update({
        phone, email: email || null, location: location || null
      }).eq('id', App.agent.id);
      
      if (error) { showToast('Error: ' + error.message, 'error'); return; }
      App.agent.phone = phone; App.agent.email = email; App.agent.location = location;
      showToast('Profile updated!');
    }

    // ============ PASSWORD CHANGE ============
    // ============ COMMISSION PLAN CHANGE (30-day lock) ============
    let planChangeTimer = null;

    function renderCommissionChange() {
      const agent = App.agent;
      if (!agent) return;
      const lockedEl = document.getElementById('commissionChangeLocked');
      const availEl = document.getElementById('commissionChangeAvailable');
      const changedAt = agent.commission_plan_changed_at ? new Date(agent.commission_plan_changed_at) : null;
      const now = new Date();
      const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

      // Highlight current plan buttons
      const btnA = document.getElementById('switchToPlanA');
      const btnB = document.getElementById('switchToPlanB');
      if (btnA && btnB) {
        const isA = agent.commission_plan === 'per_client';
        btnA.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all ' + 
          (isA ? 'bg-emerald-100 border-emerald-500 text-emerald-700 cursor-default' : 'bg-white border-slate-200 text-slate-700 hover:border-emerald-400 hover:bg-emerald-50');
        btnB.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all ' + 
          (!isA ? 'bg-emerald-100 border-emerald-500 text-emerald-700 cursor-default' : 'bg-white border-slate-200 text-slate-700 hover:border-emerald-400 hover:bg-emerald-50');
        btnA.disabled = isA;
        btnB.disabled = !isA ? true : false;
      }

      if (changedAt && (now - changedAt) < THIRTY_DAYS) {
        // LOCKED - show countdown
        lockedEl.classList.remove('hidden');
        availEl.classList.add('hidden');
        const unlockDate = new Date(changedAt.getTime() + THIRTY_DAYS);
        document.getElementById('lastPlanChangeDate').textContent = changedAt.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        document.getElementById('nextPlanChangeDate').textContent = unlockDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

        // Start countdown timer
        if (planChangeTimer) clearInterval(planChangeTimer);
        function updateCountdown() {
          const remaining = unlockDate - new Date();
          if (remaining <= 0) {
            clearInterval(planChangeTimer);
            renderCommissionChange();
            return;
          }
          const days = Math.floor(remaining / (1000*60*60*24));
          const hours = Math.floor((remaining % (1000*60*60*24)) / (1000*60*60));
          const mins = Math.floor((remaining % (1000*60*60)) / (1000*60));
          document.getElementById('planChangeCountdown').textContent = `${days}d ${hours}h ${mins}m remaining`;
          const elapsed = new Date() - changedAt;
          const pct = Math.min(100, (elapsed / THIRTY_DAYS) * 100);
          document.getElementById('planChangeProgress').style.width = pct + '%';
        }
        updateCountdown();
        planChangeTimer = setInterval(updateCountdown, 60000);
      } else {
        // AVAILABLE - show switch buttons
        lockedEl.classList.add('hidden');
        availEl.classList.remove('hidden');
      }
    }

    async function changeCommissionPlan(newPlan) {
      if (!App.agent) return;
      if (App.agent.commission_plan === newPlan) return;

      const planLabels = { per_client: 'Plan A (K100/client)', loss_based: 'Plan B (20% losses)' };
      const confirmed = confirm(`Switch to ${planLabels[newPlan]}?\n\nYou won't be able to change again for 30 days.`);
      if (!confirmed) return;

      try {
        const now = new Date().toISOString();
        const update = {
          commission_plan: newPlan,
          commission_rate: newPlan === 'loss_based' ? 20 : 0,
          per_client_amount: newPlan === 'per_client' ? 100 : 0,
          commission_plan_changed_at: now
        };
        const { error } = await App.db.from('agents').update(update).eq('id', App.agent.id);
        if (error) throw error;
        
        App.agent.commission_plan = newPlan;
        App.agent.commission_rate = update.commission_rate;
        App.agent.per_client_amount = update.per_client_amount;
        App.agent.commission_plan_changed_at = now;

        const pl = { per_client: 'Plan A: K100 per qualifying client', loss_based: 'Plan B: 20% of player losses' };
        document.getElementById('myPlanLabel').textContent = pl[newPlan];
        renderCommissionChange();
        showToast(`Switched to ${planLabels[newPlan]}!`);
        // Refresh tier display since rates depend on plan
        await loadTiers();
      } catch(e) {
        alert('Error: ' + (e.message || 'Unknown'));
      }
    }

    async function changePassword() {
      const current = document.getElementById('currentPassword').value;
      const newPw = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      if (!current || !newPw || !confirm) { showToast('Fill all password fields', 'error'); return; }
      if (newPw.length < 6) { showToast('New password must be at least 6 characters', 'error'); return; }
      if (newPw !== confirm) { showToast('New passwords don\'t match', 'error'); return; }
      
      // Verify current password
      if (current !== App.agent.password_hash) { showToast('Current password is incorrect', 'error'); return; }
      
      const { error } = await App.db.from('agents').update({ password_hash: newPw }).eq('id', App.agent.id);
      if (error) { showToast('Error: ' + error.message, 'error'); return; }
      
      App.agent.password_hash = newPw;
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      showToast('Password updated!');
    }

    // ============ PORTAL CHAT ============
    const PortalChat = {
      messages: [],
      subscription: null,

      async init() {
        try {
          const { data, error } = await App.db.from('chat_messages')
            .select('*').eq('agent_id', App.agent.id)
            .order('created_at', { ascending: true }).limit(100);
          if (error) throw error;
          this.messages = data || [];
          this.render();
          this.markRead();
          this.subscribe();
        } catch(e) {
          document.getElementById('portalChatMessages').innerHTML = '<div class="p-4 text-center text-amber-600 text-sm">Chat not available yet.</div>';
        }
      },

      render() {
        const c = document.getElementById('portalChatMessages');
        if (!c) return;
        if (this.messages.length === 0) { c.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400 text-sm"><p>No messages yet. Say hello to your manager!</p></div>'; return; }
        c.innerHTML = this.messages.map(m => {
          const isMine = m.sender_type === 'agent';
          const time = new Date(m.created_at).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
          const date = new Date(m.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
          if (isMine) {
            return `<div class="chat-msg flex justify-end"><div class="max-w-[75%]"><div class="chat-bubble-mine px-4 py-2.5"><p class="text-sm">${this.esc(m.message)}</p></div><p class="text-[10px] text-slate-400 mt-1 mr-1 text-right">You ¬∑ ${date} ${time}</p></div></div>`;
          } else {
            return `<div class="chat-msg flex justify-start"><div class="max-w-[75%]"><div class="chat-bubble-theirs px-4 py-2.5"><p class="text-sm">${this.esc(m.message)}</p></div><p class="text-[10px] text-slate-400 mt-1 ml-1">${m.sender_name||'Manager'} ¬∑ ${date} ${time}</p></div></div>`;
          }
        }).join('');
        c.scrollTop = c.scrollHeight;
      },

      async send() {
        const input = document.getElementById('portalChatInput');
        const text = input?.value.trim();
        if (!text || !App.agent) return;
        input.value = '';
        try {
          await App.db.from('chat_messages').insert({
            agent_id: App.agent.id,
            sender_type: 'agent',
            sender_id: App.agent.id,
            sender_name: App.agent.name,
            message: text,
            is_read: false
          });
          await this.reload();
        } catch(e) { showToast('Failed to send message','error'); }
      },

      async reload() {
        try {
          const { data } = await App.db.from('chat_messages').select('*').eq('agent_id', App.agent.id).order('created_at',{ascending:true}).limit(100);
          this.messages = data || [];
          this.render();
        } catch(e) {}
      },

      subscribe() {
        if (this.subscription) { this.subscription.unsubscribe(); }
        this.subscription = App.db.channel('portal-chat-' + App.agent.id)
          .on('postgres_changes', {
            event: 'INSERT', schema: 'public', table: 'chat_messages',
            filter: 'agent_id=eq.' + App.agent.id
          }, (payload) => {
            this.messages.push(payload.new);
            this.render();
            if (payload.new.sender_type === 'crm') {
              this.markRead();
              showToast('New message from manager!','info');
            }
          }).subscribe();
      },

      async markRead() {
        try {
          await App.db.from('chat_messages').update({is_read:true})
            .eq('agent_id', App.agent.id).eq('sender_type','crm').eq('is_read',false);
          const badge = document.getElementById('portalChatUnread');
          if (badge) badge.classList.add('hidden');
        } catch(e) {}
      },

      async checkUnread() {
        try {
          const { data } = await App.db.from('chat_messages').select('id')
            .eq('agent_id', App.agent.id).eq('sender_type','crm').eq('is_read',false);
          const badge = document.getElementById('portalChatUnread');
          if (badge && data && data.length > 0) {
            badge.textContent = data.length + ' new';
            badge.classList.remove('hidden');
          }
        } catch(e) {}
      },

      esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
    };

    // ============ PDF REPORT ============
    function downloadReport() {
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); const a = App.agent; const today = new Date().toLocaleDateString();
      doc.setFontSize(20); doc.setTextColor(0,128,0); doc.text('BWANABET Agent Report', 20, 20);
      doc.setFontSize(12); doc.setTextColor(100);
      doc.text('Agent: ' + a.name, 20, 35); doc.text('Promo Code: ' + a.promo_code, 20, 42);
      doc.text('Plan: ' + (a.commission_plan === 'per_client' ? 'A: K100/client' : 'B: 20% losses'), 20, 49);
      doc.text('Generated: ' + today, 20, 56);
      const tc = App.weeklyData.reduce((s,w) => s + (w.total_clients||0), 0);
      const tl = App.weeklyData.reduce((s,w) => s + parseFloat(w.total_losses||0), 0);
      const te = App.weeklyData.reduce((s,w) => s + parseFloat(w.total_earnings||0), 0);
      const tp = App.payments.filter(p => p.status === 'paid').reduce((s,p) => s + parseFloat(p.amount||0), 0);
      doc.setFontSize(14); doc.setTextColor(0); doc.text('Summary', 20, 72); doc.setFontSize(11);
      doc.text('Total Clients: ' + tc, 20, 82); doc.text('Total Losses: K' + tl.toLocaleString(), 20, 89);
      doc.text('Total Earnings: K' + te.toLocaleString(), 20, 96); doc.text('Total Paid: K' + tp.toLocaleString(), 20, 103);
      doc.text('Balance: K' + (te - tp).toLocaleString(), 20, 110);
      let y = 125; doc.setFontSize(14); doc.text('Weekly Performance', 20, y); y += 10;
      doc.setFontSize(9); doc.setTextColor(100); doc.text('Week', 20, y); doc.text('Clients', 60, y); doc.text('Qualifying', 85, y); doc.text('Losses', 115, y); doc.text('Earnings', 145, y);
      doc.setTextColor(0); App.weeklyData.slice(0,15).forEach(w => { y += 7; if(y > 270) return;
        doc.text(new Date(w.week_start_date).toLocaleDateString(), 20, y); doc.text(String(w.total_clients||0), 60, y);
        doc.text(String(w.qualifying_clients||0), 85, y); doc.text('K' + parseFloat(w.total_losses||0).toLocaleString(), 115, y);
        doc.text('K' + parseFloat(w.total_earnings||0).toLocaleString(), 145, y); });
      doc.save('BwanaBet_Report_' + a.promo_code + '_' + today.replace(/\//g, '-') + '.pdf');
    }
  </script>
</body>
</html>
